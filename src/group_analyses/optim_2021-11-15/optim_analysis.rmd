---
title: "assessing impact of analysis approaches: `r params$subjlist`"
output: html_document
params:
    subjlist: "ispc_retest"
---

```{r setup}

## libraries

library(colorout)
library(here)
library(knitr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggridges)
library(data.table)
library(abind)
library(httpgd)
source(here("src", "stroop-rsa-pc.R"))

## settings
hgd()
opts_chunk$set(echo = TRUE)
theme_set(theme_bw(base_size = 10))

## constants
#subjlist <- "ispc_retest"
subjlist <- params$subjlist
if (subjlist == "ispc_retest") {
    session <- "reactive"
} else if (subjlist == "all_retest") {
    session <- "proactive"
}
prewhs <- c("none", "obsall")
glms <- c("lsall_1rpm", "lssep_1rpm")
roiset <- "Schaefer2018Dev"
measures <- c("cveuc", "crcor")

dat <- enlist(combo_paste(measures, glms, sep = "__"))
for (measure in measures) {
    for (glmname in glms) {
        for (prewh in prewhs) {
            if (prewh == "obsall" && glmname == "lssep_1rpm") next
            file_name <- 
                construct_filename_weights(
                    measure = measure, subjlist = subjlist, glmname = glmname, roiset = roiset, prewh = prewh
                    )
            dat[[paste0(measure, "__", glmname, "__", prewh)]] <- fread(file_name)
        }
    }
}
dat <- rbindlist(dat, idcol = "id")
dat <- separate(dat, id, c("measure", "glmname", "prewh"), sep = "__")


## calculate

## for group stats:
dat_sum <- dat %>% 
    group_by(prewh, measure, glmname, term, roi, subject) %>%    ## average over waves
    summarize(b = mean(b), .groups = "drop_last") %>%
    summarize(
        t_stat = t.test(b)$statistic, 
        p = t.test(b, alternative = "greater")$p.value, 
        .groups = "keep"
        )

## for test-retest correlations:
dat_r <- dat %>% 
    pivot_wider(names_from = "wave", values_from = "b") %>%  ## spread over waves
    group_by(prewh, measure, glmname, term, roi) %>%    ## correlate over subjects
    summarize(r = cor(wave1, wave2))


```

# `r subjlist`

## cross-run correlation

```{r fig.show = "hold", out.width = "50%"}
for (mod in models$crcor) {
    rdm <- 
        read_model_rdm(
            model = mod, measure_type = "similarity", session = session, ttype_subset = "bias"
        )
    p <- rdm %>% melt_mat %>% plot_melted_mat + labs(title = mod) + theme(axis.text.x = element_text(angle = 90, hjust = 0))
    print(p)
}
```

### group stats

#### non-prewhitened

```{r}

dat_sum %>%
    filter(measure == "crcor", prewh == "none") %>%
    ggplot(aes(roi, t_stat, fill = glmname)) +
    geom_hline(yintercept = 0) +
    stat_summary(fun = "mean", position = position_dodge(width = 0.5), geom = "col") +
    facet_grid(cols = vars(term)) +
    coord_flip() +
    scale_fill_brewer(type = "qual", palette = 2) +
    theme(legend.position = "top") +
    labs(title = "group-level t stats")


dat %>%
    filter(measure == "crcor", prewh == "none") %>%
    ggplot(aes(roi, b, color = glmname)) +
    geom_hline(yintercept = 0) +
    stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = 0.5), geom = "errorbar") +
    facet_grid(cols = vars(term), scales = "free") +
    coord_flip() +
    scale_color_brewer(type = "qual", palette = 2) +
    theme(legend.position = "top") +
    labs(title = "group-level b coefficients")

```


```{r fig.height = 2.5, out.width = "100%"}

dat_sum %>%
    filter(measure == "crcor", prewh == "none") %>%
    pivot_wider(id_cols = c("term", "roi"), names_from = "glmname", values_from = "t_stat") %>%
    ggplot(aes(lsall_1rpm, lssep_1rpm)) +
    geom_hline(yintercept = 0) +
    geom_vline(xintercept = 0) +
    geom_abline() +
    geom_point(size = 0.5) +
    facet_grid(cols = vars(term)) +
    labs(title = "group-level t stats")

```


#### prewhitened: lsall_1rpm


```{r}

dat_sum %>%
    filter(measure == "crcor", glmname == "lsall_1rpm") %>%
    ggplot(aes(roi, t_stat, fill = prewh)) +
    geom_hline(yintercept = 0) +
    stat_summary(fun = "mean", position = position_dodge(width = 0.5), geom = "col") +
    facet_grid(cols = vars(term)) +
    coord_flip() +
    scale_fill_brewer(type = "qual", palette = 2) +
    theme(legend.position = "top") +
    labs(title = "group-level t stats")

dat %>%
    filter(measure == "crcor", glmname == "lsall_1rpm") %>%
    ggplot(aes(roi, b, color = prewh)) +
    geom_hline(yintercept = 0) +
    stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = 0.5), geom = "errorbar") +
    facet_grid(cols = vars(term), scales = "free") +
    coord_flip() +
    scale_color_brewer(type = "qual", palette = 2) +
    theme(legend.position = "top") +
    labs(title = "group-level b coefficients")

dat_sum %>%
    filter(measure == "crcor", glmname == "lsall_1rpm") %>%
    pivot_wider(id_cols = c("term", "roi"), names_from = "prewh", values_from = "t_stat") %>%
    ggplot(aes(none, obsall)) +
    geom_hline(yintercept = 0) +
    geom_vline(xintercept = 0) +
    geom_abline() +
    geom_point(size = 0.5) +
    facet_grid(cols = vars(term)) +
    labs(title = "group-level t stats")

```



### test-retest correlations

#### non-prewhitened

```{r}

dat_r %>%
    filter(measure == "crcor", prewh == "none") %>%
    ggplot(aes(roi, r, fill = glmname)) +
    geom_hline(yintercept = 0) +
    stat_summary(fun = "mean", position = position_dodge(width = 0.5), geom = "col") +
    facet_grid(cols = vars(term)) +
    coord_flip() +
    scale_fill_brewer(type = "qual", palette = 2) +
    theme(legend.position = "top") +
    labs(title = "test-retest correlations")

```

```{r fig.height = 2.5, out.width = "100%"}

dat_r %>%
    filter(measure == "crcor", prewh == "none") %>%
    pivot_wider(id_cols = c("term", "roi"), names_from = "glmname", values_from = "r") %>%
    ggplot(aes(lsall_1rpm, lssep_1rpm)) +
    geom_hline(yintercept = 0) +
    geom_vline(xintercept = 0) +
    geom_abline() +
    geom_point(size = 0.5) +
    facet_grid(cols = vars(term)) +
    labs(title = "test-retest correlations")

```

#### prewhitened: lsall_1rpm


```{r}

dat_r %>%
    filter(measure == "crcor", glmname == "lsall_1rpm") %>%
    ggplot(aes(roi, r, fill = prewh)) +
    geom_hline(yintercept = 0) +
    stat_summary(fun = "mean", position = position_dodge(width = 0.5), geom = "col") +
    facet_grid(cols = vars(term)) +
    coord_flip() +
    scale_fill_brewer(type = "qual", palette = 2) +
    theme(legend.position = "top") +
    labs(title = "test-retest correlations")

```

```{r fig.height = 2.5, out.width = "100%"}

dat_r %>%
    filter(measure == "crcor", glmname == "lsall_1rpm") %>%
    pivot_wider(id_cols = c("term", "roi"), names_from = "prewh", values_from = "r") %>%
    ggplot(aes(none, obsall)) +
    geom_hline(yintercept = 0) +
    geom_vline(xintercept = 0) +
    geom_abline() +
    geom_point(size = 0.5) +
    facet_grid(cols = vars(term)) +
    labs(title = "test-retest correlations")

```



### table

#### non-prewhitened

```{r}

dat_sum %>%
    full_join(dat_r) %>%
    filter(measure == "crcor", term %in% c("target", "distractor", "incongruency"), prewh == "none") %>%
    pivot_wider(names_from = c("glmname"), values_from = c("t_stat", "p", "r")) %>%
    filter(p_lsall_1rpm < 0.01 | p_lssep_1rpm < 0.01) %>%
    arrange(-t_stat_lsall_1rpm) %>%
    kable
```

#### prewhitened
```{r}
dat_sum %>%
    full_join(dat_r) %>%
    filter(measure == "crcor", term %in% c("target", "distractor", "incongruency"), prewh == "obsall") %>%
    filter(p < 0.01) %>%
    arrange(-t_stat) %>%
    kable
```
All significant ROIs at $\alpha < 0.01$ uncorrected.
Sorted by `t_stat_lsall_1rpm`.
`r_*` columns show test--retest correlations.




### cross-validated euclidean


```{r fig.show = "hold", out.width = "50%"}
for (mod in models$cveuc) {
    rdm <- 
        read_model_rdm(
            model = mod, measure_type = "cvdistance", session = session, ttype_subset = "bias"
        )
    p <- rdm %>% melt_mat %>% plot_melted_mat + labs(title = mod) + theme(axis.text.x = element_text(angle = 90, hjust = 0))
    print(p)
}
```

### group stats

#### non-prewhitened

```{r}

dat_sum %>%
    filter(measure == "cveuc", prewh == "none") %>%
    ggplot(aes(roi, t_stat, fill = glmname)) +
    geom_hline(yintercept = 0) +
    stat_summary(fun = "mean", position = position_dodge(width = 0.5), geom = "col") +
    facet_grid(cols = vars(term)) +
    coord_flip() +
    scale_fill_brewer(type = "qual", palette = 2) +
    theme(legend.position = "top") +
    labs(title = "group-level t stats")


dat %>%
    filter(measure == "cveuc", prewh == "none") %>%
    ggplot(aes(roi, b, color = glmname)) +
    geom_hline(yintercept = 0) +
    stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = 0.5), geom = "errorbar") +
    facet_grid(cols = vars(term), scales = "free") +
    coord_flip() +
    scale_color_brewer(type = "qual", palette = 2) +
    theme(legend.position = "top") +
    labs(title = "group-level b coefficients")

```


```{r fig.height = 2.5, out.width = "100%"}

dat_sum %>%
    filter(measure == "cveuc", prewh == "none") %>%
    pivot_wider(id_cols = c("term", "roi"), names_from = "glmname", values_from = "t_stat") %>%
    ggplot(aes(lsall_1rpm, lssep_1rpm)) +
    geom_hline(yintercept = 0) +
    geom_vline(xintercept = 0) +
    geom_abline() +
    geom_point(size = 0.5) +
    facet_grid(cols = vars(term)) +
    labs(title = "group-level t stats")

```

#### prewhitened: lsall_1rpm

```{r}

dat_sum %>%
    filter(measure == "cveuc", glmname == "lsall_1rpm") %>%
    ggplot(aes(roi, t_stat, fill = prewh)) +
    geom_hline(yintercept = 0) +
    stat_summary(fun = "mean", position = position_dodge(width = 0.5), geom = "col") +
    facet_grid(cols = vars(term)) +
    coord_flip() +
    scale_fill_brewer(type = "qual", palette = 2) +
    theme(legend.position = "top") +
    labs(title = "group-level t stats")


dat %>%
    filter(measure == "cveuc", glmname == "lsall_1rpm") %>%
    ggplot(aes(roi, b, color = prewh)) +
    geom_hline(yintercept = 0) +
    stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = 0.5), geom = "errorbar") +
    facet_grid(cols = vars(term), scales = "free") +
    coord_flip() +
    scale_color_brewer(type = "qual", palette = 2) +
    theme(legend.position = "top") +
    labs(title = "group-level b coefficients")

```


```{r fig.height = 2.5, out.width = "100%"}

dat_sum %>%
    filter(measure == "cveuc", glmname == "lsall_1rpm") %>%
    pivot_wider(id_cols = c("term", "roi"), names_from = "prewh", values_from = "t_stat") %>%
    ggplot(aes(none, obsall)) +
    geom_hline(yintercept = 0) +
    geom_vline(xintercept = 0) +
    geom_abline() +
    geom_point(size = 0.5) +
    facet_grid(cols = vars(term)) +
    labs(title = "group-level t stats")

```




### test-retest correlations

#### non-prewhitened


```{r}

dat_r %>%
    filter(measure == "cveuc", prewh == "none") %>%
    ggplot(aes(roi, r, fill = glmname)) +
    geom_hline(yintercept = 0) +
    stat_summary(fun = "mean", position = position_dodge(width = 0.5), geom = "col") +
    facet_grid(cols = vars(term)) +
    coord_flip() +
    scale_fill_brewer(type = "qual", palette = 2) +
    theme(legend.position = "top") +
    labs(title = "test-retest correlations")

```


```{r fig.height = 2.5, out.width = "100%"}

dat_r %>%
    filter(measure == "cveuc", prewh == "none") %>%
    pivot_wider(id_cols = c("term", "roi"), names_from = "glmname", values_from = "r") %>%
    ggplot(aes(lsall_1rpm, lssep_1rpm)) +
    geom_hline(yintercept = 0) +
    geom_vline(xintercept = 0) +
    geom_abline() +
    geom_point(size = 0.5) +
    facet_grid(cols = vars(term)) +
    labs(title = "test-retest correlations")

```

#### prewhitened: lsall_1rpm


```{r}

dat_r %>%
    filter(measure == "cveuc", glmname == "lsall_1rpm") %>%
    ggplot(aes(roi, r, fill = prewh)) +
    geom_hline(yintercept = 0) +
    stat_summary(fun = "mean", position = position_dodge(width = 0.5), geom = "col") +
    facet_grid(cols = vars(term)) +
    coord_flip() +
    scale_fill_brewer(type = "qual", palette = 2) +
    theme(legend.position = "top") +
    labs(title = "test-retest correlations")

```


```{r fig.height = 2.5, out.width = "100%"}

dat_r %>%
    filter(measure == "cveuc", glmname == "lsall_1rpm") %>%
    pivot_wider(id_cols = c("term", "roi"), names_from = "prewh", values_from = "r") %>%
    ggplot(aes(none, obsall)) +
    geom_hline(yintercept = 0) +
    geom_vline(xintercept = 0) +
    geom_abline() +
    geom_point(size = 0.5) +
    facet_grid(cols = vars(term)) +
    labs(title = "test-retest correlations")

```


### table

```{r}

dat_sum %>%
    full_join(dat_r) %>%
    filter(measure == "cveuc", prewh == "none", term %in% c("target", "distractor", "incongruency")) %>%
    pivot_wider(names_from = c("glmname"), values_from = c("t_stat", "p", "r")) %>%
    filter(p_lsall_1rpm < 0.01 | p_lssep_1rpm < 0.01) %>%
    arrange(-t_stat_lsall_1rpm) %>%
    kable

    
dat_sum %>%
    full_join(dat_r) %>%
    filter(measure == "cveuc", prewh == "obsall", term %in% c("target", "distractor", "incongruency")) %>%
    filter(p < 0.01) %>%
    arrange(-t_stat) %>%
    kable

```
All significant ROIs at $\alpha < 0.01$ uncorrected.
Sorted by `t_stat_lsall_1rpm`.
`r_*` columns show test--retest correlations.


## comparison of measures: cross-validated euclidean and cross-run correlation, lsall_1rpm

### non-prewhitened euclidean

```{r}

dat_sum %>%
    filter(term %in% c("distractor", "incongruency", "target"), prewh == "none", glmname == "lsall_1rpm") %>%
    pivot_wider(id_cols = c("glmname", "term", "roi"), names_from = "measure", values_from = "t_stat") %>%
    ggplot(aes(crcor, cveuc)) +
    geom_hline(yintercept = 0) +
    geom_vline(xintercept = 0) +
    geom_abline() +
    geom_point(size = 0.5) +
    facet_grid(rows = vars(glmname), cols = vars(term)) +
    labs(title = "t statistics", x = "cross-run correlation", y = "cross-validated euclidean")

dat_r %>%
    filter(term %in% c("distractor", "incongruency", "target"), prewh == "none", glmname == "lsall_1rpm") %>%
    pivot_wider(id_cols = c("glmname", "term", "roi"), names_from = "measure", values_from = "r") %>%
    ggplot(aes(crcor, cveuc)) +
    geom_hline(yintercept = 0) +
    geom_vline(xintercept = 0) +
    geom_abline() +
    geom_point(size = 0.5) +
    facet_grid(rows = vars(glmname), cols = vars(term)) +
    labs(title = "test--retest correlations", x = "cross-run correlation", y = "cross-validated euclidean")

```

### prewhitened euclidean

```{r}

dat_sum %>%
    filter(term %in% c("distractor", "incongruency", "target"), prewh == "obsall", glmname == "lsall_1rpm") %>%
    pivot_wider(id_cols = c("glmname", "term", "roi"), names_from = "measure", values_from = "t_stat") %>%
    ggplot(aes(crcor, cveuc)) +
    geom_hline(yintercept = 0) +
    geom_vline(xintercept = 0) +
    geom_abline() +
    geom_point(size = 0.5) +
    facet_grid(rows = vars(glmname), cols = vars(term)) +
    labs(title = "t statistics", x = "cross-run correlation", y = "cross-validated euclidean")

dat_r %>%
    filter(term %in% c("distractor", "incongruency", "target"), prewh == "obsall", glmname == "lsall_1rpm") %>%
    pivot_wider(id_cols = c("glmname", "term", "roi"), names_from = "measure", values_from = "r") %>%
    ggplot(aes(crcor, cveuc)) +
    geom_hline(yintercept = 0) +
    geom_vline(xintercept = 0) +
    geom_abline() +
    geom_point(size = 0.5) +
    facet_grid(rows = vars(glmname), cols = vars(term)) +
    labs(title = "test--retest correlations", x = "cross-run correlation", y = "cross-validated euclidean")

```
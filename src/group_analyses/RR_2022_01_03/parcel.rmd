---
title: "MI Wave 1 analyses: JNeuro reanalysis/replication"
output: 
    html_document:
        toc: true
        toc_depth: 3
        toc_float: true
        number_sections: true
        code_folding: hide
params:
    ttype_subset: "bias"
    prewh: "none"
    measure: "crcor"
    roiset: "glasser2016_parcel"
---

# intro


```{r setup, results = FALSE, message = FALSE, warning = FALSE}

## libraries ----

library(here)
library(data.table)
source(here("src", "stroop-rsa-pc.R"))
library(knitr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(mfutils)
library(ggseg)
library(ggsegExtra)
library(ggsegSchaefer)
library(ggsegGlasser)

## settings, params ----

opts_chunk$set(echo = TRUE, out.width = "100%")
theme_set(theme_bw(base_size = 10))

if (exists("params")) {
  ttype_subset <- params$ttype_subset
  prewh <- params$prewh
  measure <- params$measure
  roiset <- params$roiset
} else {
  ttype_subset <- "bias"
  prewh <- "obsall"
  measure <- "cveuc"
  roiset <- "glasser2016_parcel"
}

theme_surface <- list(
  theme(
    axis.text = element_blank(), panel.grid = element_blank(), panel.border = element_blank(),
    axis.ticks = element_blank(), legend.position = c(0.5, 0.5), legend.title = element_text(size = 5), 
    legend.background = element_blank(), legend.text = element_text(size = 5), legend.direction = "horizontal",
    legend.key.height = unit(1/5, "cm"), legend.key.width = unit(1/4, "cm")
  )
)


## constants ----

wd <- here()
subjlists <- "mi1"
seswaves <- c("proactive_wave1")
glmname <- "lsall_1rpm"
sessions <- c("proactive")
statistics <- c("m", "t_stat")
titles <- c("mean coefficient", "t statistic")


## data ----

## read regression weights:

dat <- Map(
  function(subjlist, suffix) {
    fname <- construct_filename_weights(
        measure = measure, subjlist = subjlist, glmname = glmname, 
        ttype_subset = ttype_subset, roiset = roiset, prewh = prewh, suffix = suffix
        )
    fread(fname)
  },
  subjlist = subjlists,
  suffix = paste0("__seswave-", seswaves)
)
dat <- rbindlist(dat)


## get ggseg atlas and format data to match:

dat <- dat %>% rename(region = roi)

if (roiset == "schaefer2018_17_200_parcel") {
  
  atlas <- schaefer17_200
  k <- schaefer2018_17_200_fsaverage5$key %>% select(region = parcel, network)
  
  rois <- data.frame(
    region = c(
    "17Networks_LH_ContA_PFClv_1",
    "17Networks_LH_ContA_PFCl_1",
    "17Networks_LH_ContA_PFCl_2",
    "17Networks_LH_ContA_PFCl_3",
    "17Networks_RH_ContA_PFCl_1",
    "17Networks_RH_ContA_PFCl_2",
    "17Networks_LH_SalVentAttnB_PFCmp_1",
    "17Networks_RH_SalVentAttnB_PFCmp_1",
    "17Networks_LH_SalVentAttnA_FrMed_1",
    "17Networks_RH_SalVentAttnA_FrMed_1"
    ),
    location = c(rep("lateral", 6), rep("medial", 4))
  )

} else if (roiset == "glasser2016_parcel") {
  
  atlas <- glasser
  k <- glasser2016_fsaverage5$key %>% select(region = parcel, network)
  
  dat <- dat %>% filter(!region %in% "L_10pp")  ## not in glasser ggseg atlas?
  ## create region column in ggseg atlas that matches data:
  hemi <- ifelse(atlas$data$hemi == "left", "L_", "R_")
  atlas$data$region <- ifelse(is.na(atlas$data$region), NA, paste0(hemi, atlas$data$region))
  
  rois <- data.frame(
    region = combo_paste(c("L_", "R_"), c("SCEF", "8BM",  "p32pr", "a32pr", "p9-46v", "i6-8", "8Av", "8C")),
    location = c(rep("medial", 8), rep("lateral", 8))
  )
  
}

## add network information:
atlas$data <- left_join(atlas$data, k, by = "region")
dat <- left_join(dat, k, by = "region")


## calculate ----

## add subject set information:
subjlists <- rbind(
  data.table(subjlist = "jneurosci", subject = fread(here("out", "subjlist_jneurosci_primary.txt"))[[1]]),
  data.table(subjlist = "replication", subject = 
               fread(here("out", "subjlist_jneurosci_replication_primary.txt"))[[1]])
)
dat_subjs <- dat %>% inner_join(subjlists, by = "subject")
dat_subjs <- bind_rows(dat_subjs, dat_subjs %>% mutate(subjlist = "jneurosci \u222A replication"))

dat_sum <- dat_subjs %>% 
  group_by(subjlist, session, term, wave, region) %>%
  summarize(
    m = mean(b),
    t_stat = t.test(b)$statistic, 
    p = t.test(b, alternative = "greater")$p.value,
    .groups = "drop_last"
    ) %>%
  mutate(p_fdr = p.adjust(p, "fdr"))

dat_sum <- dat_sum %>% filter(term %in% models[[measure]])

n_subjs <- table(unique(dat_subjs[, c("subject", "subjlist")])$subjlist)

```

This file displays group-level RSA model coefficients (means, test statistics).

**Analysis parameters**:

- Item type: `r params$ttype_subset`
- Prewhitening type: `r params$prewh`
- Similarity measure: `r params$measure`
- ROI set: `r params$roiset`

**Subject samples**:

Analyses are conducted with three different sets of subjects.

- the **jneurosci** set: N = `r n_subjs[["jneurosci"]]`, unrelated
  - The paper had N=49; 3 subjects are not included in these analyses: `r setdiff(subjlists$subject, dat$subject)`
  - the latter subject is not included due to failed fmriprep preprocessing
  - the former two subjects were unintentionally excluded due to meeting jo's criteria for "bad runs": >20% of TRs excluded due to high motion (I am running these subjects now)
- the **replication** set: N = `r n_subjs[["replication"]]`, unrelated (to each other and to those in jneurosci)
- the **jneurosci** $\bigcup$ **replication** set: N = `r n_subjs[["replication"]] + n_subjs[["jneurosci"]]`, unrelated


# Brains

## Unthresholded

### Common scale

```{r message = FALSE}

for (stat_i in seq_along(statistics)) {

  p <- dat_sum %>%
    ggplot() +
    geom_brain(
      aes_string(fill = statistics[stat_i]),
      atlas = atlas, position = position_brain(side ~ hemi)
      ) +
    scale_fill_viridis_c(
      option = "magma", na.value = "grey",
      breaks = scales::extended_breaks(4)
      ) +
    facet_grid(rows = vars(term), cols = vars(subjlist)) +
    theme_surface +
    labs(title = titles[stat_i], fill = NULL)

  print(p)

}


```

### Separate scales by model


```{r message = FALSE, fig.show = "hold", out.width = "50%"}

for (model_i in seq_along(models[[measure]])) {

  model <- models[[measure]][model_i]

  for (stat_i in seq_along(statistics)) {

    p <- dat_sum %>%
      filter(term %in% model) %>%
      ggplot() +
      geom_brain(
        aes_string(fill = statistics[stat_i]),
        atlas = atlas, position = position_brain(hemi + side ~ .)
        ) +
      scale_fill_viridis_c(
        option = "magma", na.value = "grey",
        breaks = scales::extended_breaks(4)
        ) +
      facet_grid(cols = vars(subjlist)) +
      theme_surface +
      theme(legend.position = c(2/3, 0.5)) +
      labs(title = paste0(titles[stat_i], ": ", model), fill = NULL)

    print(p)

  }

}

```


## Thresholded

Three consecutive thresholds are used, each more liberal than the previous:

- **p_FDR < 0.05**: parcels with mean model fit significantly greater than 0 following FDR correction over all parcels (separately per model)
- **p_uncorr < 0.05**: parcels with mean model fit significantly greater than 0 (uncorrected)
- **t_stat > 0**: parcels with mean model fit numerically greater than zero

### Common scale

```{r message = FALSE}

dat_sum$is_in_thresh_fdr <- dat_sum$p_fdr < 0.05
dat_sum$is_in_thresh_p <- dat_sum$p < 0.05
dat_sum$is_in_thresh_sign <- dat_sum$t_stat > 0

thresholds <- c("p_fdr < 0.05", "p_uncorr < 0.05", "t_stat > 0")
thresholds_nms <- c("is_in_thresh_fdr", "is_in_thresh_p", "is_in_thresh_sign")

for (thresh_i in seq_along(thresholds)) {

  threshold_nm <- thresholds_nms[thresh_i]

  for (stat_i in seq_along(statistics)) {

    dat_sum$thresh <- as.numeric(ifelse(dat_sum[[threshold_nm]], dat_sum[[statistics[stat_i]]], NA))

    p <- dat_sum %>%
      ggplot() +
      geom_brain(
        aes(fill = thresh),
        atlas = atlas, position = position_brain(side ~ hemi)
        ) +
      scale_fill_viridis_c(
        option = "magma", na.value = "grey",
        breaks = scales::extended_breaks(4)
        ) +
      facet_grid(rows = vars(term), cols = vars(subjlist)) +
      theme_surface +
      labs(title = paste0(titles[stat_i], ": thresholded at ", thresholds[thresh_i]), fill = NULL)

    print(p)

  }

}

```


# Tables


## Do identified parcels replicate?

Parcels within the **jneurosci** sample that survived FDR correction (whole-cortex) are identified.
Are these parcels still significant (uncorrected) in the **replication** sample?

Displayed are stats within the replication sample for "successfully replicated" parcels (p<0.05).

```{r, results = "asis"}

sig_orig <- dat_sum %>% filter(p_fdr < 0.05, subjlist == "jneurosci") %>% ungroup %>% select(term, region)

d <- enlist(c("target", "distractor", "incongruency"))
for (model in names(d)) {

  d[[model]] <- dat_sum %>%
    ungroup %>%
    filter(
      subjlist == "replication", term == model, region %in% sig_orig$region[sig_orig$term == model], p < 0.05
    ) %>%
    select(region, m, t_stat, p) %>%
    arrange(region)

}

lapply(d, kable)

```


## FDR significant parcels in the full dataset

Displayed are parcels that are significant after FDR correction (whole-cortex) in the higher-powered
jneurosci+replication sample.

```{r, results = "asis"}

sig_all <- dat_sum %>% 
  filter(p_fdr < 0.05, !subjlist %in% c("jneurosci", "replication")) %>%
  ungroup %>% 
  select(term, region)

d <- enlist(c("target", "distractor", "incongruency"))
for (model in names(d)) {
  
  d[[model]] <- dat_sum %>% 
    ungroup %>%
    filter(
      !subjlist %in% c("jneurosci", "replication"), 
      term == model, 
      region %in% sig_all$region[sig_all$term == model], 
      p_fdr < 0.05
    ) %>%
    select(region, m, t_stat, p) %>%
    arrange(region)

}

lapply(d, kable)

```


## ROI-based analysis

Which ROIs (parcels) survive FDR correction over the reduced set of `r nrow(rois)` ROIs?
This is tested separately for each subject set (jneuro, replication, jneuro+replication).

```{r, results = "asis"}

dat_sum_rois <- dat_sum %>% filter(region %in% rois$region) %>% mutate(p_fdr = p.adjust(p, "fdr"))

d <- enlist(c("target", "distractor", "incongruency"))
for (model in names(d)) {
  
  d[[model]] <- dat_sum_rois %>% 
    ungroup %>%
    filter(term == model, p_fdr < 0.05) %>%
    select(region, subjlist, m, t_stat, p, p_fdr) %>%
    arrange(region, subjlist)
}

lapply(d, kable)

```





# Bar plots

```{r, message = FALSE}
## prep for plotting:

dat_subjs_barplots <- dat_subjs %>% 
  mutate(
    term = factor(term, levels = c("target", "incongruency", "distractor")),
    region_nice = gsub("17Networks_", "", region)
    ) %>%
  filter(term %in% c("target", "distractor", "incongruency"))

```


## ROIs


```{r, message = FALSE}

atlas$data %>%
  ggplot() +
    geom_brain(
      aes(fill = ifelse(region %in% rois$region, region, NA)),
      atlas = atlas, position = position_brain(side ~ hemi)
      ) +
  labs(title = paste0("ROIs: ", roiset), fill = NULL) +
  theme_surface +
  theme(legend.text = element_text(size = 10))


dat_subjs_barplots %>%
  
  right_join(rois, by = "region") %>%
  
  ggplot(aes(region_nice, b, fill = term, color = term)) +
  geom_hline(yintercept = 0, color = "grey70") +
  stat_summary(
    fun.data = mean_cl_boot, geom = "errorbar", width = 0, size = 2/3, position = position_dodge(width = 0.5),
    color = "grey50"
    ) +
  stat_summary(fun = mean, geom = "col", width = 1/3, position = position_dodge(width = 0.5)) +
  
  scale_color_brewer(type = "qual", palette = 2) +
  scale_fill_brewer(type = "qual", palette = 2) +
  
  facet_grid(cols = vars(subjlist), rows = vars(location), scales = "free_y") +
  theme(
    #axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), 
    legend.position = "none", axis.title.y = element_blank()
    ) +
    labs(y = "mean coefficient", title = paste0("ROIs: ", roiset)) +
  coord_flip()

```



<!-- ## By network -->

<!-- ```{r} -->

<!-- for (net in unique(dat_subjs$network)) { -->

<!--   p <- dat_subjs_barplots %>% -->

<!--     filter(network == net) %>% -->

<!--     ggplot(aes(region_nice, b, fill = term, color = term)) + -->
<!--     geom_hline(yintercept = 0, color = "grey70") + -->
<!--     stat_summary( -->
<!--       fun.data = mean_cl_boot, geom = "errorbar", width = 0, size = 2/3, position = position_dodge(width = 0.5), -->
<!--       color = "grey50" -->
<!--       ) + -->
<!--     stat_summary(fun = mean, geom = "col", width = 1/3, position = position_dodge(width = 0.5)) + -->

<!--     scale_color_brewer(type = "qual", palette = 2) + -->
<!--     scale_fill_brewer(type = "qual", palette = 2) + -->

<!--     facet_grid(cols = vars(subjlist), scales = "free_y") + -->
<!--     theme( -->
<!--       #axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),  -->
<!--       legend.position = "none", axis.title.y = element_blank() -->
<!--       ) + -->
<!--     labs(y = "mean coefficient", title = net) + -->
<!--     coord_flip() -->

<!--   print(p) -->

<!-- } -->


<!-- ``` -->
